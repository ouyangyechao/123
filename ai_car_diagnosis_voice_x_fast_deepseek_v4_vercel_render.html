<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>汽车AI智能诊断系统</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/><link href="style.css" rel="stylesheet"/>

<style>
/* 隐藏所有页面语音识别旁边的“结束”按钮，但保留DOM以兼容原有脚本 */
.voice-end-wrapper,
.voice-end-btn.voice-end-chat {
    display: none !important;
}

/* 语音识别浮层右上角关闭按钮样式 */
.voice-close-btn {
    position: absolute;
    top: 8px;
    right: 12px;
    background: transparent;
    border: none;
    font-size: 24px;
    line-height: 1;
    color: #fff;
    cursor: pointer;
}

/* ====== 展示用：放大各模块标题字号，方便投屏讲解 ====== */
.page-title,
.diagnosis-title {
    font-size: 1.9rem;
}

.page-subtitle,
.diagnosis-subtitle {
    font-size: 1.2rem;
}

.form-title,
.auth-title {
    font-size: 1.3rem;
}

.profile-nav-btn {
    font-size: 1.05rem;
}


</style>

</head>
<body>
<!-- ===================================================== -->
<!-- ① UI：开场动画（系统启动页）                          -->
<!-- ===================================================== -->
<div id="intro-screen">
<div class="logo">汽车<span>AI智能诊断</span></div>
<div class="subtitle">智能诊断 · 精准维修 · 专业服务</div>
<div class="loading-bar">
<div class="loading-progress"></div>
</div>
<div class="loading-text">正在初始化系统...</div>
</div>
<!-- ===================================================== -->
<!-- ② 系统状态组件：API 连接指示                         -->
<!-- ===================================================== -->
<div class="api-status connecting" id="api-status">
<i class="fas fa-circle"></i> 连接AI服务中...
    </div>
<!-- ===================================================== -->
<!-- ③ 语音交互组件：全局语音识别浮层                     -->
<!-- ===================================================== -->
<div class="voice-indicator" id="voice-indicator">
<button class="voice-close-btn" id="voice-close-btn">&times;</button>
<div class="voice-pulse">
<i class="fas fa-microphone fa-2x"></i>
</div>
<p>正在聆听...请说话</p>
</div>
<!-- ===================================================== -->
<!-- ④ 页面模块：登录 / 注册                              -->
<!-- ===================================================== -->
<div class="page" id="page-auth">
<div class="page-content">
<div class="page-header">
<div>
<div class="page-title">欢迎使用汽车AI智能诊断系统</div>
<div class="page-subtitle">请登录或注册以开始使用</div>
</div>
</div>
<div class="auth-container">
<div class="auth-form">
<h2 class="auth-title">汽车AI智能诊断</h2>
<p class="auth-subtitle">智能诊断 · 精准维修 · 专业服务</p>
<div class="auth-tabs">
<div class="auth-tab active" id="login-tab">登录</div>
<div class="auth-tab" id="register-tab">注册</div>
</div>
<!-- 错误提示 -->
<div class="error-message" id="auth-error"></div>
<div class="auth-form-content active" id="login-form">
<div class="form-group">
<label class="form-label">手机号</label>
<input class="form-input" id="login-phone" placeholder="请输入手机号" type="tel"/>
</div>
<div class="form-group">
<label class="form-label">密码</label>
<input class="form-input" id="login-password" placeholder="请输入密码" type="password"/>
</div>
<button class="btn btn-block" id="login-btn">登录</button>
</div>
<div class="auth-form-content" id="register-form">
<div class="form-group">
<label class="form-label">手机号</label>
<input class="form-input" id="register-phone" placeholder="请输入手机号" type="tel"/>
</div>
<div class="form-group">
<label class="form-label">密码</label>
<input class="form-input" id="register-password" placeholder="请输入密码" type="password"/>
</div>
<div class="form-group">
<label class="form-label">确认密码</label>
<input class="form-input" id="register-confirm" placeholder="请再次输入密码" type="password"/>
</div>
<button class="btn btn-block" id="register-btn">注册</button>
</div>
</div>
</div>
</div>
</div>
<!-- ===================================================== -->
<!-- ⑤ 全局导航栏                                         -->
<!-- ===================================================== -->
<div class="navbar" id="navbar" style="display: none;">
<div class="logo" style="font-size: 1.2rem; color: var(--dark);">汽车<span style="color: var(--accent);">AI智能诊断</span></div>
<div class="nav-links">
<div class="nav-link active" data-page="page-brand">首页</div>
<div class="nav-link" data-page="page-profile">个人中心</div>
<div class="nav-link" id="logout-btn">退出登录</div>
</div>
</div>
<!-- ===================================================== -->
<!-- ⑥ 页面模块：品牌选择（系统首页）                     -->
<!-- ===================================================== -->
<div class="page" id="page-brand">
<div class="page-content">
<div class="page-header">
<div>
<div class="page-title">选择汽车品牌</div>
<div class="page-subtitle">请选择您要诊断的汽车品牌</div>
</div>
</div>
<div class="brands-container">
<div class="search-box">
<i class="fas fa-search search-icon"></i>
<input class="search-input" id="brand-search-input" placeholder="搜索汽车品牌..." type="text"/>
</div>
<div class="category-tabs">
<div class="category-tab active" data-category="all">全部品牌</div>
<div class="category-tab" data-category="德系">德系</div>
<div class="category-tab" data-category="日系">日系</div>
<div class="category-tab" data-category="美系">美系</div>
<div class="category-tab" data-category="国产">国产</div>
<div class="category-tab" data-category="新能源">新能源</div>
<div class="category-tab" data-category="韩系">韩系</div>
</div>
<div class="brands-grid" id="brands-grid">
<!-- 品牌卡片将通过JavaScript动态生成 -->
</div>
</div>
</div>
</div>
<!-- ===================================================== -->
<!-- ⑦ 页面模块：车辆信息录入（VIN / 型号 / 年份）        -->
<!-- ===================================================== -->
<div class="page" id="page-vehicle">
<div class="page-content">
<div class="page-header">
<div>
<button class="back-btn" id="back-to-brands">
<i class="fas fa-arrow-left"></i> 返回品牌选择
                    </button>
</div>
<div>
<div class="page-title">车辆信息录入</div>
<div class="page-subtitle">请输入车辆详细信息以开始诊断</div>
</div>
<div></div> <!-- 占位元素 -->
</div>
<div class="vehicle-form-container">
<div class="vehicle-form">
<h2 class="form-title">车辆信息</h2>
<p class="form-subtitle">请准确输入车辆信息，系统将基于此进行智能诊断</p>
<div class="selected-brand" id="selected-brand-display">
<!-- 选中的品牌信息将通过JavaScript动态生成 -->
</div>
<div class="form-group">
<label class="form-label">VIN码</label>
<div class="input-with-icon">
<input class="form-input" id="vin-input" placeholder="请输入17位车辆识别码" type="text"/>
<button class="voice-input-btn" id="voice-input-btn">
<i class="fas fa-microphone"></i>
</button>
</div>
<div class="voice-end-wrapper">
<button class="voice-end-btn" id="voice-end-vin" type="button">
                                结束
                            </button>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">汽车型号</label>
<select class="form-input" id="model-select">
<option value="">请选择型号</option>
<!-- 型号选项将通过JavaScript动态生成 -->
</select>
</div>
<div class="form-group">
<label class="form-label">生产年份</label>
<select class="form-input" id="year-select">
<option value="">请选择年份</option>
<!-- 年份选项将通过JavaScript动态生成 -->
</select>
</div>
</div>
<button class="btn btn-block" id="start-diagnosis-btn">开始AI诊断</button>
</div>
</div>
</div>
</div>
<!-- ===================================================== -->
<!-- ⑧ 页面模块：问题描述（故障信息采集）                 -->
<!-- ===================================================== -->
<div class="page" id="page-problem">
<div class="page-content">
<div class="page-header">
<div>
<button class="back-btn" id="back-to-vehicle">
<i class="fas fa-arrow-left"></i> 返回车辆信息
                    </button>
</div>
<div>
<div class="page-title">问题描述</div>
<div class="page-subtitle">请输入您遇到的问题</div>
</div>
<div></div> <!-- 占位元素 -->
</div>
<div class="problem-form-container">
<div class="problem-form">
<h2 class="form-title">问题描述</h2>
<p class="form-subtitle">请输入您遇到的问题，AI助手将为您提供诊断方案</p>
<textarea class="problem-input" id="problem-input" placeholder="例如：车辆无法启动、发动机异响、充电故障等..."></textarea>
<div class="suggested-problems">
<div class="suggested-problem">车辆无法启动</div>
<div class="suggested-problem">发动机异响</div>
<div class="suggested-problem">刹车系统故障</div>
<div class="suggested-problem">空调不制冷</div>
<div class="suggested-problem">交流无法充电</div>
<div class="suggested-problem">电池续航下降</div>
</div>
<div class="input-with-icon">
<button class="voice-input-btn" id="problem-voice-btn">
<i class="fas fa-microphone"></i>
</button>
</div>
<div class="voice-end-wrapper">
<button class="voice-end-btn" id="voice-end-problem" type="button">
                            结束
                        </button>
</div>
<button class="btn btn-block" id="submit-problem-btn">提交问题并开始诊断</button>
</div>
</div>
</div>
</div>
<!-- ===================================================== -->
<!-- ⑨ 核心页面：AI 智能诊断对话区（语音 + 文本）         -->
<!-- ===================================================== -->
<div class="page" id="page-chat">
<div class="page-content">
<div class="chat-diagnosis-container">
<div class="diagnosis-header">
<div>
<div class="diagnosis-title">汽车AI智能诊断</div>
<div class="diagnosis-subtitle" id="diagnosis-subtitle">正在诊断：交流无法充电问题</div>
</div>
<div class="diagnosis-actions">
<button class="back-btn" id="back-to-problem">
<i class="fas fa-arrow-left"></i> 返回
                        </button>
</div>
</div>
<!-- 对话内容区（含动态头像） -->
<div class="diagnosis-content" id="diagnosis-content">
<!-- 动态头像 -->
<div class="avatar-container">
<div class="waveform-bars"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
<div class="chat-avatar" id="chat-avatar">
<div class="avatar-wave"></div>
<div class="avatar-wave"></div>
<div class="avatar-wave"></div>
<i class="fas fa-robot"></i>
</div>
</div>
<!-- 初始诊断问题 -->
<div class="diagnosis-question fade-in-text" id="diagnosis-question">
                        车辆是否能上高压电？
                    </div>
</div>
<!-- 输入区域 -->
<div class="diagnosis-input-container">
<button class="diagnosis-action-btn" id="diagnosis-voice-btn" title="语音输入">
<i class="fas fa-microphone"></i>
</button>
<button class="voice-end-btn voice-end-chat" id="voice-end-chat" type="button">
                        结束
                    </button>
<!-- 保留输入框和发送按钮供脚本内部使用，但在UI中隐藏 -->
<input class="diagnosis-input" id="diagnosis-input" placeholder="输入您的回答..." type="text">
<button class="diagnosis-send-btn" id="diagnosis-send-btn">
<i class="fas fa-paper-plane"></i>
</button>
</input></div>
</div>
</div>
</div>
<!-- ===================================================== -->
<!-- ⑩ 页面模块：个人中心 / 诊断历史 / 设置               -->
<!-- ===================================================== -->
<div class="page" id="page-profile">
<div class="page-content">
<div class="page-header">
<div>
<button class="back-btn" id="back-to-home">
<i class="fas fa-arrow-left"></i> 返回首页
                    </button>
</div>
<div>
<div class="page-title">个人中心</div>
<div class="page-subtitle">管理您的个人信息和诊断历史</div>
</div>
<div></div> <!-- 占位元素 -->
</div>
<div class="profile-container">
<div class="profile-form">
<div class="profile-avatar">
<i class="fas fa-user"></i>
</div>
<!-- 个人中心导航 -->
<div class="profile-nav-container">
<div class="profile-nav-btn active" data-tab="profile-info">个人信息</div>
<div class="profile-nav-btn" data-tab="diagnosis-history">诊断历史</div>
<div class="profile-nav-btn" data-tab="settings">设置</div>
</div>
<div class="profile-content active" id="profile-info">
<div class="form-group">
<label class="form-label">联系电话</label>
<input class="form-input" id="profile-phone" placeholder="请输入您的联系电话" type="tel"/>
</div>
<div class="form-group">
<label class="form-label">车牌号</label>
<input class="form-input" id="profile-plate" placeholder="请输入您的车牌号" type="text"/>
</div>
<div class="profile-stats">
<div class="stat-card">
<div class="stat-value" id="diagnosis-count">0</div>
<div class="stat-label">诊断次数</div>
</div>
<div class="stat-card">
<div class="stat-value" id="solved-count">0</div>
<div class="stat-label">已解决问题</div>
</div>
<div class="stat-card">
<div class="stat-value" id="saved-count">0</div>
<div class="stat-label">保存的诊断</div>
</div>
</div>
<button class="btn btn-block" id="save-profile-btn">保存个人信息</button>
<button class="btn btn-block" id="logout-profile-btn" style="margin-top: 12px; background: var(--secondary);">退出登录</button>
</div>
<div class="profile-content" id="diagnosis-history">
<h3 style="margin-bottom: 16px; color: var(--dark); font-size: 1.1rem;">诊断历史记录</h3>
<div class="history-list" id="diagnosis-history-list">
<!-- 诊断历史将通过JavaScript动态生成 -->
</div>
</div>
<div class="profile-content" id="settings">
<h3 style="margin-bottom: 16px; color: var(--dark); font-size: 1.1rem;">应用设置</h3>
<div class="settings-option">
<div>
<div class="settings-label">语音输入</div>
<div class="settings-description">启用语音输入功能</div>
</div>
<label class="toggle-switch">
<input checked="" id="voice-input-toggle" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="settings-option">
<div>
<div class="settings-label">播音腔语音反馈</div>
<div class="settings-description">启用AI播音腔语音输出</div>
</div>
<label class="toggle-switch">
<input checked="" id="voice-output-toggle" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="settings-option">
<div>
<div class="settings-label">自动保存诊断</div>
<div class="settings-description">自动保存所有诊断记录</div>
</div>
<label class="toggle-switch">
<input checked="" type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div class="settings-option">
<div>
<div class="settings-label">深色模式</div>
<div class="settings-description">切换到深色主题</div>
</div>
<label class="toggle-switch">
<input type="checkbox"/>
<span class="toggle-slider"></span>
</label>
</div>
<div style="margin-top: 24px;">
<button class="btn btn-block" id="clear-data-btn" style="background: var(--danger);">清除所有数据</button>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- ================== 前端主业务脚本：登录 / 导航 / 固定诊断流程 等 ================== -->
<script src="script.js"></script>
<!-- ================== 前端增强脚本：语音浮层控制 + 问题描述文本清洗 ================== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 语音浮层关闭按钮：结束语音识别
    var closeBtn = document.getElementById('voice-close-btn');
    if (closeBtn) {
        closeBtn.addEventListener('click', function () {
            try {
                var endButtons = document.querySelectorAll('.voice-end-btn');
                endButtons.forEach(function (btn) {
                    if (btn && typeof btn.click === 'function') {
                        btn.click();
                    }
                });
            } catch (e) {
                console.error(e);
            }
            var indicator = document.getElementById('voice-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        });
    }

    // 问题描述页面：去掉语音输入结果中的标点符号
    var problemInput = document.getElementById('problem-input');
    if (problemInput) {
        var lastValue = problemInput.value || '';
        setInterval(function () {
            var current = problemInput.value || '';
            if (current !== lastValue) {
                // 去掉常见中英文标点
                var cleaned = current.replace(/[.,，。！？!？?:：;；'"“”‘’、]/g, '');
                if (cleaned !== current) {
                    var selectionStart = problemInput.selectionStart;
                    var selectionEnd = problemInput.selectionEnd;
                    problemInput.value = cleaned;
                    if (typeof selectionStart === 'number' && typeof selectionEnd === 'number') {
                        var diff = current.length - cleaned.length;
                        problemInput.selectionStart = Math.max(0, selectionStart - diff);
                        problemInput.selectionEnd = Math.max(0, selectionEnd - diff);
                    }
                }
                lastValue = problemInput.value;
            }
        }, 200);
    }
});
</script>
<!-- ================== AI 诊断脚本：DeepSeek 接入 + 对话逻辑控制 ================== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ===================== DeepSeek 模式状态 =====================
    var problemInput = document.getElementById('problem-input');
    var submitProblemBtn = document.getElementById('submit-problem-btn');

    var diagnosisSubtitle = document.getElementById('diagnosis-subtitle');
    var diagnosisQuestion = document.getElementById('diagnosis-question');
    var diagnosisVoiceBtn = document.getElementById('diagnosis-voice-btn');
    var diagnosisInput = document.getElementById('diagnosis-input');
    var diagnosisSendBtn = document.getElementById('diagnosis-send-btn');
    var apiStatusEl = document.getElementById('api-status');
    var voiceIndicator = document.getElementById('voice-indicator');
    var voiceOutputToggle = document.getElementById('voice-output-toggle');

    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    var hasSpeechRecognition = !!SpeechRecognition;

    var deepseekEndpoint = 'https://houduan1.onrender.com/api/deepseek-chat';
    var healthEndpoint = 'https://houduan1.onrender.com/api/health';

    var deepseekState = {
        enabled: false,          // true: 使用 DeepSeek；false: 使用原有固定脚本
        problemText: '',
        messages: [],
        recognition: null,
        recognitionActive: false
    };

    var voiceOutputEnabled = voiceOutputToggle ? voiceOutputToggle.checked : true;
    if (voiceOutputToggle) {
        voiceOutputToggle.addEventListener('change', function () {
            voiceOutputEnabled = !!this.checked;
        });
    }

    // ===================== 捕获原有播音腔音色 =====================
    var originalSpeak = null;
    var lastVoiceConfig = null;

    if ('speechSynthesis' in window && window.speechSynthesis && !window.__deepseekSpeechWrapped) {
        originalSpeak = window.speechSynthesis.speak.bind(window.speechSynthesis);
        window.__deepseekOriginalSpeak = originalSpeak;
        window.__deepseekSpeechWrapped = true;

        window.speechSynthesis.speak = function (utter) {
            try {
                // 只在第一次说话时记录一份参数，用于后续 DeepSeek 复用同样的音色
                if (!lastVoiceConfig) {
                    lastVoiceConfig = {
                        lang: utter.lang,
                        rate: utter.rate,
                        pitch: utter.pitch,
                        voice: utter.voice || null
                    };
                }

                // 在 DeepSeek 模式下，只播放 DeepSeek 标记过的语音，
                // 避免原有脚本额外播报导致“声音和文字不一致”
                if (typeof deepseekState !== 'undefined' && deepseekState && deepseekState.enabled) {
                    if (!utter._fromDeepSeek) {
                        // 非 DeepSeek 语音在此模式下直接忽略
                        return;
                    }
                }
            } catch (e) {
                console.error(e);
            }
            originalSpeak(utter);
        };
    } else if (window.__deepseekOriginalSpeak) {
        originalSpeak = window.__deepseekOriginalSpeak;
    }

    function speakWithLastConfig(text) {
        if (!voiceOutputEnabled) return;
        if (!originalSpeak || !window.SpeechSynthesisUtterance || !text) return;

        try {
            var utter = new SpeechSynthesisUtterance(text);
            // 标记为 DeepSeek 播报，便于在全局 speak 包装中区分
            utter._fromDeepSeek = true;
            if (lastVoiceConfig) {
                if (lastVoiceConfig.lang) utter.lang = lastVoiceConfig.lang;
                if (typeof lastVoiceConfig.rate === 'number') utter.rate = lastVoiceConfig.rate;
                if (typeof lastVoiceConfig.pitch === 'number') utter.pitch = lastVoiceConfig.pitch;
                if (lastVoiceConfig.voice) utter.voice = lastVoiceConfig.voice;
            }
            originalSpeak(utter);
        } catch (e) {
            console.error(e);
        }
    }

    // ===================== API 状态指示 =====================
    function setApiStatus(state, text) {
        if (!apiStatusEl) return;
        apiStatusEl.classList.remove('connecting', 'online', 'offline');
        apiStatusEl.classList.add(state);
        if (text) {
            apiStatusEl.innerHTML = '<i class="fas fa-circle"></i> ' + text;
        }
    }

    // 启动时检测后端健康状态
    if (apiStatusEl && healthEndpoint) {
        fetch(healthEndpoint)
            .then(function (res) {
                if (!res.ok) throw new Error();
                return res.json();
            })
            .then(function () {
                setApiStatus('online', 'AI 诊断服务已连接');
            })
            .catch(function () {
                setApiStatus('offline', 'AI 服务连接失败');
            });
    }

    // ===================== 工具函数 =====================
    function getCarInfoSummary() {
        var brandBox = document.getElementById('selected-brand-display');
        var brandText = brandBox ? brandBox.textContent.replace(/\\s+/g, ' ').trim() : '未选择品牌';

        var modelSelect = document.getElementById('model-select');
        var yearSelect = document.getElementById('year-select');

        var model = '';
        if (modelSelect) {
            if (modelSelect.value) {
                model = modelSelect.value;
            } else if (modelSelect.selectedIndex >= 0) {
                model = modelSelect.options[modelSelect.selectedIndex].text;
            }
        }

        var year = '';
        if (yearSelect) {
            if (yearSelect.value) {
                year = yearSelect.value;
            } else if (yearSelect.selectedIndex >= 0) {
                year = yearSelect.options[yearSelect.selectedIndex].text;
            }
        }

        return '品牌/车系：' + (brandText || '未选择') +
            '，型号：' + (model || '未选择') +
            '，年份：' + (year || '未选择');
    }

    function ensureDeepSeekSessionStarted() {
        if (!deepseekState.enabled) return;
        if (deepseekState.messages.length > 0) return;

        var carInfo = getCarInfoSummary();

        deepseekState.messages.push({
            role: 'system',
            content: '你是一名经验丰富的新能源汽车故障诊断工程师，善于用简洁、分步的方式远程指导维修技师。' +
                '请使用简体中文回答，每次回复控制在 2~4 句，并且明确给出下一步检查建议。'
        });

        deepseekState.messages.push({
            role: 'user',
            content: carInfo +
                '。\\n客户的故障描述是：“' + deepseekState.problemText +
                '”。\\n请先用一段话概括可能的故障方向，并说明你接下来需要向我了解哪些关键信息（可以直接用问句向我提问）。'
        });

        callDeepSeek();
    }

    async function callDeepSeek() {
        if (!deepseekState.enabled) return;

        if (diagnosisQuestion) {
            diagnosisQuestion.textContent = 'AI 正在分析，请稍候...';
        }
        setApiStatus('connecting', '正在向 DeepSeek 请求诊断...');

        try {
            var resp = await fetch(deepseekEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ messages: deepseekState.messages })
            });

            if (!resp.ok) {
                throw new Error('HTTP 状态码 ' + resp.status);
            }

            var data = await resp.json();
            var reply = data.reply || '诊断服务暂时不可用，请稍后重试。';

            deepseekState.messages.push({
                role: 'assistant',
                content: reply
            });

            if (diagnosisQuestion) {
                diagnosisQuestion.textContent = reply;
                // DeepSeek 回复到达后，再显示文字
                diagnosisQuestion.style.visibility = 'visible';
            }

            // 使用原来的播音腔音色朗读 DeepSeek 回复，
            // 保证“声音”和下方显示的文字完全一致
            var finalText = diagnosisQuestion ? diagnosisQuestion.textContent : reply;
            speakWithLastConfig(finalText);

            setApiStatus('online', 'AI 诊断服务已连接');
        } catch (e) {
            console.error('调用 DeepSeek 接口失败：', e);
            if (diagnosisQuestion) {
                diagnosisQuestion.textContent = '调用 DeepSeek 失败，请确认后端已启动，并检查网络与 API Key。';
            }
            setApiStatus('offline', 'AI 服务连接失败');
        }
    }

    function handleUserAnswerForDeepSeek(text) {
        if (!deepseekState.enabled) return;
        if (!text) return;

        deepseekState.messages.push({
            role: 'user',
            content: text
        });

        if (diagnosisInput) {
            diagnosisInput.value = '';
        }

        callDeepSeek();
    }

    function startRecognitionForDeepSeek(onResult) {
        if (!hasSpeechRecognition) {
            alert('当前浏览器不支持语音识别，请使用最新版 Chrome 浏览器。');
            return;
        }

        if (deepseekState.recognitionActive && deepseekState.recognition) {
            deepseekState.recognition.stop();
        }

        var recognition = new SpeechRecognition();
        deepseekState.recognition = recognition;
        recognition.lang = 'zh-CN';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        deepseekState.recognitionActive = true;

        if (voiceIndicator) {
            voiceIndicator.style.display = 'flex';
        }

        recognition.onresult = function (event) {
            try {
                var text = event.results[0][0].transcript || '';
                if (typeof onResult === 'function') {
                    onResult(text);
                }
            } catch (e) {
                console.error(e);
            }
        };

        recognition.onerror = function (event) {
            console.error('语音识别错误：', event);
        };

        recognition.onend = function () {
            deepseekState.recognitionActive = false;
            if (voiceIndicator) {
                voiceIndicator.style.display = 'none';
            }
        };

        recognition.start();
    }

    function stopRecognitionForDeepSeek() {
        if (deepseekState.recognition && deepseekState.recognitionActive) {
            deepseekState.recognition.stop();
        }
    }

    // 所有“结束”按钮点击时，顺便停止 DeepSeek 自己的识别
    var voiceEndButtons = document.querySelectorAll('.voice-end-btn');
    voiceEndButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
            stopRecognitionForDeepSeek();
        });
    });

    // ===================== 事件绑定 =====================

    // 1）提交问题：只负责判断是否进入 DeepSeek 模式，不阻断原有脚本逻辑
    if (submitProblemBtn) {
        submitProblemBtn.addEventListener('click', function () {
            if (!problemInput) return;
            var text = (problemInput.value || '').trim();
            if (!text) return; // 原脚本会自己做校验和提示

            deepseekState.problemText = text;
            // 只要问题里“不是”交流无法充电，就走 DeepSeek
            deepseekState.enabled = text.indexOf('交流无法充电') === -1;

            if (deepseekState.enabled) {
                // 在 DeepSeek 模式下，先隐藏原来的首句“车辆是否能上高压电？”
                if (diagnosisQuestion) {
                    diagnosisQuestion.style.visibility = 'hidden';
                }
            }

            if (deepseekState.enabled && diagnosisSubtitle) {
                diagnosisSubtitle.textContent = '正在诊断：' + text;
            }

            if (deepseekState.enabled) {
                // 给原脚本一点时间完成页面切换，再启动 DeepSeek 会话
                setTimeout(function () {
                    ensureDeepSeekSessionStarted();
                }, 600);
            }
        });
    }

    // 2）对话页面语音按钮：DeepSeek 模式下接管点击事件，其余情况交给原有脚本
    if (diagnosisVoiceBtn) {
        diagnosisVoiceBtn.addEventListener('click', function (e) {
            if (!deepseekState.enabled) return; // 固定脚本模式，完全交给原逻辑
            e.stopPropagation();
            e.preventDefault();

            startRecognitionForDeepSeek(function (text) {
                if (diagnosisInput) {
                    diagnosisInput.value = text;
                }
                handleUserAnswerForDeepSeek(text);
            });
        }, true); // 捕获阶段
    }

    // 3）发送按钮（如果需要键盘输入）
    if (diagnosisSendBtn) {
        diagnosisSendBtn.addEventListener('click', function (e) {
            if (!deepseekState.enabled) return;
            e.stopPropagation();
            e.preventDefault();
            if (!diagnosisInput) return;

            var text = (diagnosisInput.value || '').trim();
            handleUserAnswerForDeepSeek(text);
        }, true); // 捕获
    }
});
</script>

</body>
</html>